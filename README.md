# Morning Brief Assistant

A production-ready Python tool that sends you a concise, friendly Slack DM every morning at 07:30 Europe/Oslo with:

- **Today's agenda** from Google Calendar
- **Notion tasks** due today (grouped by Area)
- **Gmail important items** from the past 24 hours
- **Voice note** generated by ElevenLabs (optional, with OpenAI polish)

The brief includes both a text summary and an audio voice note (MP3) attached to the same Slack message. Tasks are automatically grouped by their Area relation property, and the voice note uses OpenAI to create a natural, conversational script.

## Features

- **Defensive**: If any provider fails, a partial brief is still delivered
- **Voice note**: Optional ElevenLabs TTS with OpenAI-generated natural script
- **Task grouping**: Automatically groups Notion tasks by Area
- **Thread-aware**: Gmail counts threads, not individual messages
- **OAuth**: Google credentials persisted in `token.json`
- **Timezone-aware**: Default `Europe/Oslo` (configurable)
- **Scheduled**: GitHub Actions runs daily at 06:30 UTC → 07:30 Europe/Oslo (winter)

## Requirements

- Python 3.11+
- Slack app with bot token
- Google API project with Calendar and Gmail enabled
- Notion integration with access to your tasks database (and Areas database for task grouping)
- (Optional) ElevenLabs account for voice notes
- (Optional) OpenAI API key for natural voice script generation

## Installation

```bash
# Clone the repository
git clone <your-repo-url>
cd morning-brief-assistant

# Create virtual environment
python -m venv .venv
source .venv/bin/activate  # On Windows: .venv\Scripts\activate

# Install dependencies
pip install -r requirements.txt
```

## Environment Variables

Copy `.env.example` to `.env` and fill in your values:

### Required

- `SLACK_BOT_TOKEN` - Your Slack bot token (starts with `xoxb-`)
- `SLACK_USER_ID` - Your Slack user ID (the recipient of the DM)
- `SLACK_FALLBACK_CHANNEL` - Channel to post to if DM fails (e.g., `#daily-brief`)
- `NOTION_API_KEY` - Your Notion integration secret
- `NOTION_TASK_DATABASE_ID` - The database ID of your tasks database
- `GOOGLE_CALENDAR_ID` - Your Google Calendar ID (default: `primary`)

### Optional (Google OAuth)

If you use `client_secret.json` file, you can skip these:
- `GOOGLE_OAUTH_CLIENT_ID` - Google OAuth client ID
- `GOOGLE_OAUTH_CLIENT_SECRET` - Google OAuth client secret

### Optional (Gmail)

- `GMAIL_QUERY` - Gmail search query (default: `label:INBOX newer_than:1d`)
- `IMPORTANT_SENDERS` - Comma-separated list of important email addresses (optional)
- `GMAIL_MAX` - Maximum number of email threads to include (default: `5`)

### Optional (Notion)

- `NOTION_DONE_VALUES` - Comma-separated values for "done" status (default: `Done,Completed,Finished,Closed`)

### Optional (General)

- `DAYS_AHEAD` - Days to look ahead (default: `14`, not currently used)
- `TZ` - Timezone (default: `Europe/Oslo`)

### Optional (OpenAI - for voice script)

- `OPENAI_API_KEY` - Your OpenAI API key
- `OPENAI_MODEL` - Model to use (default: `gpt-4o-mini`)

### Optional (ElevenLabs - for voice note)

- `ELEVENLABS_API_KEY` - Your ElevenLabs API key
- `ELEVENLABS_VOICE_ID` - The voice ID to use
- `ELEVENLABS_MODEL_ID` - Model to use (default: `eleven_multilingual_v2`)
- `VOICE_MIN_SECS` - Minimum voice note length in seconds (default: `45`)
- `VOICE_MAX_SECS` - Maximum voice note length in seconds (default: `70`)
- `MOCK_ELEVENLABS` - Set to `true` to skip ElevenLabs API calls (saves credits during testing)

## Setup Instructions

### Google OAuth Setup

1. Go to [Google Cloud Console](https://console.cloud.google.com/)
2. Create a new project (or select existing)
3. Enable **Calendar API** and **Gmail API**
4. Go to "Credentials" → "Create Credentials" → "OAuth client ID"
5. Choose "Desktop app" as the application type
6. Download the credentials file and save it as `client_secret.json` in the project root
   - OR set `GOOGLE_OAUTH_CLIENT_ID` and `GOOGLE_OAUTH_CLIENT_SECRET` in `.env`
7. On first run, a browser will open for OAuth authentication
8. After authentication, `token.json` will be created (keep this file secure)

**Note**: For GitHub Actions, you'll need to upload `token.json` as a secret or use a service account.

### Slack Setup

1. Go to [Slack API](https://api.slack.com/apps) and create a new app
2. Install the app to your workspace
3. Go to "OAuth & Permissions"
4. Add the following **Bot Token Scopes**:
   - `chat:write` - Send messages
   - `im:write` - Send direct messages
   - `files:write` - Upload files (for audio attachment)
   - `users:read` - Read user info
5. Copy the **Bot User OAuth Token** (starts with `xoxb-`) to `SLACK_BOT_TOKEN`
6. Find your Slack user ID:
   - Right-click your profile in Slack → "Copy member ID"
   - Or use the Slack API: `curl https://slack.com/api/auth.test -H "Authorization: Bearer YOUR_TOKEN"`
   - Set this as `SLACK_USER_ID`

### Notion Setup

1. Go to [Notion Integrations](https://www.notion.so/my-integrations)
2. Click "New integration"
3. Give it a name (e.g., "Morning Brief Assistant")
4. Copy the **Internal Integration Token** to `NOTION_API_KEY`
5. Open your tasks database in Notion
6. Click "..." in the top right → "Add connections" → Select your integration
7. Copy the database ID from the URL:
   - URL format: `https://www.notion.so/YOUR-WORKSPACE/DATABASE_ID?v=...`
   - The database ID is the long string before the `?`
   - Set this as `NOTION_TASK_DATABASE_ID`

**For Area grouping to work:**
8. Open your Areas database in Notion
9. Click "..." → "Add connections" → Select your integration
10. This allows the bot to fetch Area names for task grouping

**Optional**: If your "Done" status uses different values, set `NOTION_DONE_VALUES` (comma-separated).

### ElevenLabs Audio Setup

1. Create an account at [ElevenLabs](https://elevenlabs.io)
2. Go to "Profile → API Keys" → Create a new API key
3. Copy the key to `ELEVENLABS_API_KEY`
4. Go to "Voice Lab" or browse stock voices
5. Copy a voice ID to `ELEVENLABS_VOICE_ID`
6. Set `ELEVENLABS_MODEL_ID` (default: `eleven_multilingual_v2`)

**For testing without using credits:**
- Set `MOCK_ELEVENLABS=true` in `.env`

### OpenAI Setup (Optional but Recommended)

1. Get an API key from [OpenAI](https://platform.openai.com/api-keys)
2. Set `OPENAI_API_KEY` in `.env`
3. Optionally set `OPENAI_MODEL` (default: `gpt-4o-mini`)

OpenAI is used to generate a natural, conversational voice script from structured data. Without it, the voice note will use the raw text summary.

## Local Run

```bash
python -m src.main
```

This will:
- Fetch today's calendar events
- Fetch today's Notion tasks (grouped by Area)
- Fetch today's important emails
- Generate a text summary
- (If OpenAI configured) Generate a natural voice script
- (If ElevenLabs configured) Generate an MP3 audio file
- Send both to your Slack DM

The summary is also printed to stdout for debugging.

## GitHub Actions Setup

The workflow runs daily at 06:30 UTC (07:30 Europe/Oslo in winter).

### Setting up GitHub Secrets

1. Go to your GitHub repository
2. Navigate to **Settings** → **Secrets and variables** → **Actions**
3. Click **New repository secret**
4. Add each environment variable from your `.env` file as a secret:
   - `SLACK_BOT_TOKEN`
   - `SLACK_USER_ID`
   - `SLACK_FALLBACK_CHANNEL`
   - `NOTION_API_KEY`
   - `NOTION_TASK_DATABASE_ID`
   - `GOOGLE_CALENDAR_ID`
   - `GOOGLE_OAUTH_CLIENT_ID` (optional if using `client_secret.json`)
   - `GOOGLE_OAUTH_CLIENT_SECRET` (optional if using `client_secret.json`)
   - `GOOGLE_TOKEN_BASE64` (see detailed instructions below)
   - `GMAIL_QUERY` (optional)
   - `IMPORTANT_SENDERS` (optional)
   - `GMAIL_MAX` (optional)
   - `OPENAI_API_KEY` (optional)
   - `OPENAI_MODEL` (optional)
   - `ELEVENLABS_API_KEY` (optional)
   - `ELEVENLABS_VOICE_ID` (optional)
   - `ELEVENLABS_MODEL_ID` (optional)
   - `VOICE_MIN_SECS` (optional)
   - `VOICE_MAX_SECS` (optional)
   - `TZ` (optional, default: `Europe/Oslo`)

### Google OAuth in GitHub Actions

Since GitHub Actions can't do interactive OAuth authentication, you need to provide a pre-authenticated token:

**Step 1: Generate token.json locally**
```bash
python -m src.main
```
This will open a browser for OAuth and create `token.json` in your project root.

**Step 2: Encode token.json**
On macOS/Linux:
```bash
base64 -i token.json
```
On Linux (alternative):
```bash
base64 token.json
```

Copy the entire output (it's one long string).

**Step 3: Add as GitHub Secret**
1. Go to your repo → **Settings** → **Secrets and variables** → **Actions**
2. Click **New repository secret**
3. Name: `GOOGLE_TOKEN_BASE64`
4. Value: Paste the entire base64 string you copied
5. Click **Add secret**

**Step 4: Done!**
The workflow already includes a step to decode this automatically. No code changes needed.

**Alternative: Service Account (Advanced)**
If you prefer not to use OAuth tokens, you can create a service account in Google Cloud Console and use that instead (requires code modifications).

### Manual Trigger

You can also trigger the workflow manually:
1. Go to **Actions** tab in GitHub
2. Select "Morning Brief" workflow
3. Click **Run workflow** → **Run workflow**

## Troubleshooting

### Notion tasks not showing up
- Ensure your integration has access to the Tasks database
- Check that tasks have due dates set
- Verify `NOTION_TASK_DATABASE_ID` is correct
- Check logs for property detection issues

### Notion Area not grouping
- Ensure your integration has access to the **Areas database**
- Share the Areas database with your integration (same as Tasks database)
- Check that tasks have Area relations assigned in Notion

### Gmail only showing 1 email
- Check `IMPORTANT_SENDERS` - if set but empty, it may filter emails
- Leave `IMPORTANT_SENDERS` empty to show all emails
- The bot counts **threads**, not individual messages

### Google OAuth keeps asking for login
- Ensure `client_secret.json` is a "Desktop app" type (not "Web application")
- Check that `token.json` is being created and persisted
- Verify file permissions on `token.json`

### ElevenLabs not working
- Check API key and voice ID are correct
- Verify you have credits in your ElevenLabs account
- Set `MOCK_ELEVENLABS=true` to test without API calls
- Check logs for specific error messages

### Voice note too slow/fast
- The bot uses ElevenLabs `speed` parameter (if supported) or adjusts `stability` in voice_settings
- Text preprocessing removes pauses (slashes, arrows → commas)
- Adjust `stability` in code if needed (lower = faster, more dynamic)

## Project Structure

```
.
├── src/
│   ├── main.py              # Main orchestration
│   ├── config.py            # Settings and env vars
│   ├── summarizer.py        # Text summary generation
│   ├── mcp_client.py        # HTTP client for MCP server
│   ├── models/              # Pydantic models
│   └── utils/               # Helper functions
├── mcp-server/              # MCP server (Next.js/TypeScript)
│   ├── app/api/mcp/         # HTTP API endpoint
│   └── src/tools/           # Tool implementations (calendar, gmail, notion, slack, etc.)
├── .github/workflows/
│   ├── run.yml              # GitHub Actions workflow (runs Python script)
│   └── deploy-mcp-server.yml # Deploys MCP server to Vercel
├── requirements.txt         # Python dependencies
└── README.md               # This file
```

## License

MIT
