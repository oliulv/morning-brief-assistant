# Morning Brief Assistant

A production-ready personal assistant that sends you a concise, friendly Slack DM every morning with:

- **Today's agenda** from Google Calendar
- **Notion tasks** due today (grouped by Area)
- **Gmail important items** from the past 24 hours
- **Voice note** generated by ElevenLabs (optional, with OpenAI polish)

The brief includes both a text summary and an audio voice note (MP3) attached to the same Slack message. Tasks are automatically grouped by their Area relation property, and the voice note uses OpenAI to create a natural, conversational script.

## Architecture

This project uses a **Model Context Protocol (MCP)** server architecture:

```
┌─────────────────────┐
│   Python Client     │  ← Runs daily via GitHub Actions
│   (main.py)         │  ← Orchestrates the morning brief
└──────────┬──────────┘
           │
           │ HTTP (MCP Protocol)
           │
┌──────────▼──────────┐
│   MCP Server        │  ← Hosted on Vercel
│   (Next.js/TS)      │  ← Provides tools via HTTP API
│                     │
│   Tools:            │
│   • Google Calendar │
│   • Gmail           │
│   • Notion          │
│   • OpenAI          │
│   • ElevenLabs      │
│   • Slack           │
└─────────────────────┘
```

**Why MCP?**
- **Separation of concerns**: Client orchestrates, server handles API integrations
- **Reusability**: MCP server tools can be used by other clients
- **Scalability**: Server deployed to Vercel with auto-scaling
- **Maintainability**: Tools are independently testable and deployable

## Features

- **Defensive**: If any provider fails, a partial brief is still delivered
- **Voice note**: Optional ElevenLabs TTS with OpenAI-generated natural script
- **Task grouping**: Automatically groups Notion tasks by Area
- **Thread-aware**: Gmail counts threads, not individual messages
- **OAuth**: Google credentials persisted securely
- **Timezone-aware**: Default `Europe/Oslo` (configurable)
- **Scheduled**: GitHub Actions runs daily at 06:30 UTC → 07:30 Europe/Oslo (winter)
- **MCP Protocol**: Uses standardized Model Context Protocol for tool access

## Requirements

### For Python Client
- Python 3.11+
- Access to deployed MCP server (or run locally)

### For MCP Server Deployment
- Node.js 18+
- Vercel account (free tier works)
- API keys for:
  - Slack (bot token)
  - Google (OAuth credentials)
  - Notion (integration token)
  - ElevenLabs (optional, for voice)
  - OpenAI (optional, for voice script)

## Quick Start

### 1. Deploy MCP Server to Vercel

The MCP server must be deployed first, as the Python client connects to it.

```bash
# Install Vercel CLI
npm install -g vercel

# Navigate to MCP server directory
cd mcp-server

# Install dependencies
npm install

# Deploy to Vercel (follow prompts)
npx vercel
```

During deployment, Vercel will ask for your project name and settings. After deployment, you'll get a URL like:
```
https://your-project.vercel.app
```

**Set environment variables in Vercel:**
1. Go to your Vercel dashboard
2. Select your project → **Settings** → **Environment Variables**
3. Add the following variables (see [MCP Server Environment Variables](#mcp-server-environment-variables) section):

Required:
- `SLACK_BOT_TOKEN`
- `GOOGLE_OAUTH_CLIENT_ID`
- `GOOGLE_OAUTH_CLIENT_SECRET`
- `GOOGLE_TOKEN_BASE64`
- `NOTION_API_KEY`

Optional (but recommended):
- `SLACK_USER_ID`
- `SLACK_FALLBACK_CHANNEL`
- `GOOGLE_CALENDAR_ID`
- `NOTION_TASK_DATABASE_ID`
- `OPENAI_API_KEY`
- `ELEVENLABS_API_KEY`
- `ELEVENLABS_VOICE_ID`
- And others (see full list below)

4. Redeploy after adding environment variables:
```bash
npx vercel --prod
```

### 2. Set Up Python Client

```bash
# Clone the repository
git clone <your-repo-url>
cd morning-brief-assistant

# Create virtual environment
python -m venv .venv
source .venv/bin/activate  # On Windows: .venv\Scripts\activate

# Install dependencies
pip install -r requirements.txt
```

### 3. Configure Environment Variables

Copy `.env.example` to `.env` and set:

```bash
# MCP Server URL (your deployed Vercel URL)
MCP_SERVER_URL=https://your-project.vercel.app/api/mcp

# Your Slack user ID (for receiving DMs)
SLACK_USER_ID=U123456789

# Optional: Override server-side settings
SLACK_FALLBACK_CHANNEL=#daily-brief
TZ=Europe/Oslo
```

### 4. Run Locally

```bash
python -m src.main
```

The client will:
1. Connect to your MCP server
2. Fetch calendar, email, and task data via MCP tools
3. Generate summary and voice note
4. Send to your Slack DM

## Detailed Setup

### MCP Server Environment Variables

Add these to your Vercel project:

#### Required

**Slack:**
- `SLACK_BOT_TOKEN` - Bot token from Slack (starts with `xoxb-`)

**Google:**
- `GOOGLE_OAUTH_CLIENT_ID` - OAuth client ID from Google Cloud Console
- `GOOGLE_OAUTH_CLIENT_SECRET` - OAuth client secret
- `GOOGLE_TOKEN_BASE64` - Base64-encoded `token.json` (see [Google OAuth Setup](#google-oauth-setup))

**Notion:**
- `NOTION_API_KEY` - Integration secret from Notion

#### Optional

**Slack:**
- `SLACK_USER_ID` - Your Slack user ID (for DMs)
- `SLACK_FALLBACK_CHANNEL` - Channel if DM fails (e.g., `general` or `#daily-brief`)

**Google:**
- `GOOGLE_CALENDAR_ID` - Calendar ID (default: `primary`)

**Gmail:**
- `GMAIL_QUERY` - Search query (default: `label:INBOX newer_than:1d`)
- `IMPORTANT_SENDERS` - Comma-separated important email addresses
- `GMAIL_MAX` - Max emails to show (default: `5`)

**Notion:**
- `NOTION_TASK_DATABASE_ID` - Your tasks database ID
- `NOTION_DONE_VALUES` - Comma-separated "done" status values (default: `Done,Completed,Finished,Closed`)

**General:**
- `DAYS_AHEAD` - Days to look ahead (default: `14`)
- `TZ` - Timezone (default: `Europe/Oslo`)

**OpenAI (for voice script):**
- `OPENAI_API_KEY` - OpenAI API key
- `OPENAI_MODEL` - Model to use (default: `gpt-4o-mini`)

**ElevenLabs (for voice note):**
- `ELEVENLABS_API_KEY` - ElevenLabs API key
- `ELEVENLABS_VOICE_ID` - Voice ID
- `ELEVENLABS_MODEL_ID` - Model (default: `eleven_multilingual_v2`)

### Python Client Environment Variables

Create a `.env` file in the project root:

```bash
# MCP Server URL (required)
MCP_SERVER_URL=https://your-project.vercel.app/api/mcp

# Slack (optional - overrides server defaults)
SLACK_USER_ID=U123456789
SLACK_FALLBACK_CHANNEL=#daily-brief

# Timezone (optional - overrides server default)
TZ=Europe/Oslo

# OpenAI/ElevenLabs (optional - for local testing)
OPENAI_API_KEY=sk-...
ELEVENLABS_API_KEY=...
ELEVENLABS_VOICE_ID=...
ELEVENLABS_MODEL_ID=eleven_multilingual_v2

# Mock mode (optional - for testing without API calls)
MOCK_ELEVENLABS=true
```

## API Setup Guides

### Google OAuth Setup

1. Go to [Google Cloud Console](https://console.cloud.google.com/)
2. Create a new project or select existing
3. Enable **Google Calendar API** and **Gmail API**
4. Go to **Credentials** → **Create Credentials** → **OAuth client ID**
5. Choose **Desktop app** as application type
6. Download `client_secret.json`

**Generate token.json:**
```bash
# Run locally to trigger OAuth flow
python -m src.main
```
This opens a browser for authentication and creates `token.json`.

**Encode for Vercel:**
```bash
# On macOS/Linux
base64 -i token.json

# Copy the output and add as GOOGLE_TOKEN_BASE64 in Vercel
```

**Also add to Vercel:**
- Extract `client_id` from `client_secret.json` → `GOOGLE_OAUTH_CLIENT_ID`
- Extract `client_secret` from `client_secret.json` → `GOOGLE_OAUTH_CLIENT_SECRET`

### Slack Setup

1. Go to [Slack API](https://api.slack.com/apps) → **Create New App**
2. Choose **From scratch**, name it, select workspace
3. Go to **OAuth & Permissions**
4. Add **Bot Token Scopes**:
   - `chat:write` - Send messages
   - `im:write` - Send DMs
   - `files:write` - Upload files (for audio)
   - `users:read` - Read user info
5. Click **Install to Workspace**
6. Copy **Bot User OAuth Token** → `SLACK_BOT_TOKEN`

**Find your Slack user ID:**
- Right-click your profile → **Copy member ID**
- Or: `curl https://slack.com/api/auth.test -H "Authorization: Bearer YOUR_BOT_TOKEN"`
- Set as `SLACK_USER_ID`

### Notion Setup

1. Go to [Notion Integrations](https://www.notion.so/my-integrations)
2. Click **New integration**
3. Name it (e.g., "Morning Brief Assistant")
4. Copy **Internal Integration Token** → `NOTION_API_KEY`

**Connect to databases:**
5. Open your **Tasks database** in Notion
6. Click **•••** → **Add connections** → Select your integration
7. Copy database ID from URL:
   ```
   https://www.notion.so/YOUR-WORKSPACE/DATABASE_ID?v=...
   ```
   Set as `NOTION_TASK_DATABASE_ID`

8. **For Area grouping**: Repeat step 6 for your **Areas database**

### ElevenLabs Setup (Optional)

1. Create account at [ElevenLabs](https://elevenlabs.io)
2. Go to **Profile** → **API Keys** → Create key
3. Copy key → `ELEVENLABS_API_KEY`
4. Browse voices, copy a voice ID → `ELEVENLABS_VOICE_ID`

**Testing without credits:**
Set `MOCK_ELEVENLABS=true` in your `.env`

### OpenAI Setup (Optional but Recommended)

1. Get API key from [OpenAI](https://platform.openai.com/api-keys)
2. Copy key → `OPENAI_API_KEY`
3. Optionally set model → `OPENAI_MODEL` (default: `gpt-4o-mini`)

OpenAI generates natural, conversational voice scripts. Without it, voice uses the raw text summary.

## GitHub Actions Setup

The workflow runs daily at 06:30 UTC.

### Configure GitHub Secrets

1. Go to your repo → **Settings** → **Secrets and variables** → **Actions**
2. Add **Repository secret**:
   - Name: `MCP_SERVER_URL`
   - Value: `https://your-project.vercel.app/api/mcp`

3. Optionally add client-side overrides:
   - `SLACK_USER_ID`
   - `SLACK_FALLBACK_CHANNEL`
   - `TZ`

**Note:** Most configuration is in Vercel environment variables, so you only need to add the MCP server URL to GitHub.

### Manual Trigger

1. Go to **Actions** tab
2. Select **Morning Brief** workflow
3. Click **Run workflow**

## Local Development

### Run MCP Server Locally

```bash
cd mcp-server
npm install
npm run dev
```

Server runs on `http://localhost:3000`

Set in `.env`:
```bash
MCP_SERVER_URL=http://localhost:3000/api/mcp
```

### Test MCP Server

```bash
cd mcp-server
node test-mcp.js
```

Or:
```bash
bash test-mcp.sh
```

### Run Python Client

```bash
python -m src.main
```

Or test full flow:
```bash
python test_full_flow.py
```

## Troubleshooting

### MCP Server Issues

**500 Internal Server Error:**
- Check Vercel logs: Dashboard → Deployment → View Function Logs
- Verify all required environment variables are set
- Check API keys are valid

**404 Not Found:**
- Verify URL is `https://your-project.vercel.app/api/mcp` (not `/api/mcp/route`)
- Check Vercel deployment succeeded

**Authentication errors:**
- Re-encode `token.json` and update `GOOGLE_TOKEN_BASE64`
- Verify OAuth client credentials match `token.json`

### Slack Upload Issues

**File upload fails:**
- Ensure `files:write` scope is added to your Slack bot
- Check `SLACK_BOT_TOKEN` is valid and starts with `xoxb-`
- Verify Slack user ID is correct

### Notion Issues

**Tasks not showing:**
- Ensure integration connected to Tasks database
- Verify `NOTION_TASK_DATABASE_ID` is correct
- Check tasks have due dates

**Areas not grouping:**
- Connect integration to Areas database (same as Tasks)
- Verify tasks have Area relations in Notion

### Gmail Issues

**Only showing 1 email:**
- Check `IMPORTANT_SENDERS` - empty string filters all emails
- Bot counts threads, not individual messages
- Adjust `GMAIL_QUERY` to broaden search

### ElevenLabs Issues

**Voice generation fails:**
- Verify API key and voice ID
- Check account has credits
- Try `MOCK_ELEVENLABS=true` to test flow
- Review server logs for specific errors

### Google OAuth Issues

**Token expired:**
- Regenerate `token.json` locally
- Re-encode and update `GOOGLE_TOKEN_BASE64` in Vercel
- Redeploy MCP server

## Project Structure

```
.
├── src/                      # Python client
│   ├── main.py               # Main orchestration
│   ├── config.py             # Settings and env vars
│   ├── summarizer.py         # Text summary generation
│   ├── mcp_client.py         # MCP HTTP client
│   ├── models/               # Pydantic models
│   │   ├── calendar_models.py
│   │   ├── email_models.py
│   │   └── task_models.py
│   ├── providers/            # Legacy (deprecated)
│   └── utils/                # Helper functions
│
├── mcp-server/               # MCP server (Next.js/TypeScript)
│   ├── app/
│   │   └── api/mcp/
│   │       └── route.ts      # MCP HTTP endpoint
│   ├── lib/tools/            # Tool implementations
│   │   ├── calendar.ts       # Google Calendar
│   │   ├── gmail.ts          # Gmail
│   │   ├── notion.ts         # Notion tasks
│   │   ├── openai.ts         # Voice script generation
│   │   ├── elevenlabs.ts     # TTS synthesis
│   │   ├── slack.ts          # Slack messaging
│   │   └── google-auth.ts    # OAuth helpers
│   ├── src/tools/            # Duplicate (legacy)
│   ├── test-mcp.js           # Test script
│   ├── package.json
│   └── vercel.json           # Vercel config
│
├── .github/workflows/
│   ├── run.yml               # Daily brief workflow
│   └── deploy-mcp-server.yml # Auto-deploy MCP to Vercel
│
├── requirements.txt          # Python dependencies
├── test_full_flow.py         # End-to-end test
└── README.md                 # This file
```

## How It Works

1. **GitHub Actions** triggers Python client daily at 06:30 UTC
2. **Python client** (`src/main.py`):
   - Connects to MCP server via HTTP
   - Calls MCP tools to fetch data:
     - `get_calendar_events` - Today's schedule
     - `get_gmail_messages` - Recent emails
     - `get_notion_tasks` - Due tasks
   - Generates text summary
   - Calls `generate_voice_script` (OpenAI)
   - Calls `synthesize_speech` (ElevenLabs)
   - Calls `post_to_slack` (text summary)
   - Calls `upload_file_to_slack` (audio file)
3. **MCP server** handles all API integrations
4. **Slack** receives DM with text + audio attachment

## Updating the MCP Server

After making changes to `mcp-server/`:

```bash
cd mcp-server
npm run build

# Test locally first
npm run dev

# Deploy to Vercel
npx vercel --prod
```

Or push to main branch - GitHub Actions auto-deploys via `.github/workflows/deploy-mcp-server.yml`

## Security Notes

- Never commit `.env`, `token.json`, or `client_secret.json`
- Use GitHub Secrets for sensitive values
- Use Vercel Environment Variables for server config
- `token.json` should be regenerated if compromised
- Keep API keys secure and rotate regularly

## Contributing

1. Fork the repository
2. Create a feature branch
3. Make changes
4. Test locally
5. Submit pull request

## License

MIT

## Acknowledgments

- **Model Context Protocol (MCP)** for standardized tool access
- **Vercel** for serverless hosting
- **Next.js** for MCP server framework
- **ElevenLabs** for natural voice synthesis
- **OpenAI** for voice script generation
