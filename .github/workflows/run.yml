name: Morning Brief

on:
  schedule:
    - cron: '30 6 * * *'
  workflow_dispatch:

permissions:
  contents: read

jobs:
  run:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Setup Google OAuth Token (if provided)
        env:
          GOOGLE_TOKEN_BASE64: ${{ secrets.GOOGLE_TOKEN_BASE64 }}
        run: |
          if [ -n "$GOOGLE_TOKEN_BASE64" ]; then
            echo "$GOOGLE_TOKEN_BASE64" | base64 -d > token.json
            echo "Google OAuth token set up successfully"
          else
            echo "GOOGLE_TOKEN_BASE64 not set, skipping token setup"
          fi

      - name: Run
        env:
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}
          SLACK_USER_ID: ${{ secrets.SLACK_USER_ID }}
          SLACK_FALLBACK_CHANNEL: ${{ secrets.SLACK_FALLBACK_CHANNEL }}
          NOTION_API_KEY: ${{ secrets.NOTION_API_KEY }}
          NOTION_TASK_DATABASE_ID: ${{ secrets.NOTION_TASK_DATABASE_ID }}
          NOTION_DONE_VALUES: ${{ secrets.NOTION_DONE_VALUES }}
          GOOGLE_CALENDAR_ID: ${{ secrets.GOOGLE_CALENDAR_ID }}
          GOOGLE_OAUTH_CLIENT_ID: ${{ secrets.GOOGLE_OAUTH_CLIENT_ID }}
          GOOGLE_OAUTH_CLIENT_SECRET: ${{ secrets.GOOGLE_OAUTH_CLIENT_SECRET }}
          GMAIL_QUERY: ${{ secrets.GMAIL_QUERY }}
          IMPORTANT_SENDERS: ${{ secrets.IMPORTANT_SENDERS }}
          GMAIL_MAX: ${{ secrets.GMAIL_MAX }}
          DAYS_AHEAD: ${{ secrets.DAYS_AHEAD }}
          TZ: ${{ secrets.TZ }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          OPENAI_MODEL: ${{ secrets.OPENAI_MODEL }}
          ELEVENLABS_API_KEY: ${{ secrets.ELEVENLABS_API_KEY }}
          ELEVENLABS_VOICE_ID: ${{ secrets.ELEVENLABS_VOICE_ID }}
          ELEVENLABS_MODEL_ID: ${{ secrets.ELEVENLABS_MODEL_ID }}
          VOICE_MIN_SECS: ${{ secrets.VOICE_MIN_SECS }}
          VOICE_MAX_SECS: ${{ secrets.VOICE_MAX_SECS }}
          MOCK_ELEVENLABS: ${{ secrets.MOCK_ELEVENLABS }}
        run: |
          python -m src.main


